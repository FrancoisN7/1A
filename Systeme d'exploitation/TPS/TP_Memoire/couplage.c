#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <fcntl.h>
#include <errno.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <sys/wait.h> /* wait */

void garnir(char zone[], int lg, char motif) {
	int ind;
	for (ind=0; ind<lg; ind++) {
		zone[ind] = motif ;
	}
}

void lister(char zone[], int lg) {
	int ind;
	for (ind=0; ind<lg; ind++) {
		printf("%c",zone[ind]);
	}
	printf("\n");
}

int main(int argc,char *argv[]) {
	int taillepage = sysconf(_SC_PAGESIZE);
    int nb_pages = 2;
    char buf[taillepage*nb_pages];
    int desc;
    char* base;

    //Créer un fichier contenant nb_pages pages de 'a'
    garnir(buf,nb_pages * taillepage,'a');

    //Ouvrir le fichier en lecture
    desc = open("temp.txt", O_RDWR | O_CREAT | O_TRUNC, 0700);
    write(desc, buf, nb_pages*taillepage);

    //Coupler un segment de taille nb_pages pages en lecture/écriture
    base = mmap(0, nb_pages*taillepage, PROT_WRITE|PROT_READ, MAP_SHARED, desc, 0);

    if (base == MAP_FAILED){
        printf("Je n'ai pas réussi le map");
    }

    //Créer un processus fils;
    pid_t pidFils ;
    int tempsFils = 2;
    pidFils = fork ();
    int idFils, codeTerm;
    /* bonne pratique : tester systématiquement le retour des appels système */
    if (pidFils == -1) {
        printf ("Erreur fork\n");
        exit (1);
    }
    /* par convention, renvoyer une valeur > 0 en cas d’erreur ,
    * différente pour chaque cause d’erreur */
    
    if (pidFils == 0) { /* fils */
        sleep (tempsFils);
        //Afficher les 10 1er caractères de la 1ère page
        lister(base, 10);
        //Afficher les 10 1er caractères de la 2e page
        lister(base + taillepage, 10);
        garnir(base, taillepage,'c');
        printf ("fin du fils\n");
        exit (EXIT_SUCCESS); 
        } 
    else { /* père */
        garnir(base+taillepage, taillepage,'b');
        printf ("fin du père\n");
        //Attendre la fin du fils
        idFils = waitpid(pidFils,&codeTerm,0);
        if (idFils == -1) {
            perror ("wait");
            exit (8);
        }
        if (WEXITSTATUS(codeTerm) == 0) {
            //Afficher les 10 1er caractères à la fin
            lister(base,10);
        }
    }
}